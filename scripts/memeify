#!/bin/bash

function usage {
        echo "usage: $(basename $0) [-mnd] input output 'top text' 'bottom text'" 2>&1
        echo '   -m   classic meme style'
        echo '   -n   new meme style'
        echo '   -d   deep fried meme style'
        exit 1
}

if [[ ${#} -eq 0 ]]; then
   usage
fi

# Define list of arguments expected in the input
optstring=":mnd"

while getopts ${optstring} arg; do
  case "${arg}" in
    m)
        if [ -n "$4" ]; then #check if top caption is actually empty
            magick convert $2 -resize 1024x $3   #make sure image is 1024px wide
            magick convert $3 -size 1024x256 -alpha set -background none -font Impact -stroke black -fill white -strokewidth 2 -gravity north label:"$4" -composite $3  #top caption
            else echo "you forgot the caption!"
        fi
        if [ "$#" = 5 ]; then    #check if we're asked for a bottom caption
            if [ -n "$4" ]; then #check if bottom caption is actually empty
                magick convert $3 -size 1024x256 -alpha set -background none -font Impact -stroke black -fill white -strokewidth 2 -gravity south label:"$5" -composite $3  #bottom caption
            fi
        fi 
    ;;
    n)
        if [ -n "$4" ]; then #check if caption is actually empty
            TMP=$(mktemp -d)    #make temp directory
            magick convert $2 -resize 1024x $3      #make sure image is 1024px wide
            magick -background white -fill black -size 1024x -pointsize 72 -gravity northwest caption:"$4" "$TMP"/tmp.png      #generate label
            magick montage "$TMP"/tmp.png $3 -geometry +0+0 -tile 1x $3    #combine images
            rm -r "$TMP"    #cleanup
            else echo "you forgot the caption!"
        fi
    ;;
    d)
        TMP=$(mktemp -d)            #make temporary directory
        cp "$2" "$TMP"/tmp0.png     #there is a better way to do this for sure
        if  (( "$#" > 3 )); then    #check for caption text
            if [ -n "$4" ]; then    #make sure caption isn't empty
                if [ -n "$4" ]; then #check if top caption is actually empty
                    magick convert $2 -resize 1024x "$TMP"/tmp0.png   #make sure image is 1024px wide
                    magick convert "$TMP"/tmp0.png -size 1024x256 -alpha set -background none -font Impact -stroke black -fill white -strokewidth 2 -gravity north label:"$4"    -composite "$TMP"/tmp0.png  #top caption
                    else echo "you forgot the caption!"
                fi
                if [ "$#" = 5 ]; then    #check if we're asked for a bottom caption
                    if [ -n "$4" ]; then #check if bottom caption is actually empty
                        magick convert "$TMP"/tmp0.png -size 1024x256 -alpha set -background none -font Impact -stroke black -fill white -strokewidth 2 -gravity south label:"$5" -composite "$TMP"/tmp0.png  #bottom caption
                    fi
                fi 
            fi
        fi
        magick convert "$TMP"/tmp0.png -quality 5 -modulate 100,200 -resize 256x -sharpen 10 +noise uniform "$TMP"/tmp1.jpg  #deep fry
        magick convert "$TMP"/tmp1.jpg "$3"  #output
        rm -r "$TMP"  #cleanup
    ;;
    ?)
      echo "Invalid option: -${OPTARG}."
      echo
      usage
      ;;
  esac
done